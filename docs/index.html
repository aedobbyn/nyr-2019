<!DOCTYPE html>
<html>
  <head>
    <title>This Talk is on Fire</title>
    <meta charset="utf-8">
    <meta name="author" content="Amanda Dobbyn" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/shinobi.css" rel="stylesheet" />
    
      <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="dobbs.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# This Talk is on Fire
## <code>Using Twitter and Google to Track Fires in NYC</code>
### Amanda Dobbyn

---





class: inverse

## Quick About Me

&lt;br&gt;

.left-column[

**Day job**: Data Scientist at [Earlybird Software](http://www.earlybird.co/), former co-organizer of [R-Ladies Chicago](https://rladieschicago.org/)

**For fun**: ultimate frisbee player
&lt;!-- .pull-left[![](./img/pingpong.jpg)] --&gt;

**GitHub**: [@aedobbyn](https://github.com/aedobbyn)

**Website**: https://dobb.ae

**Twitter**: [@dobbleobble](https://twitter.com/dobbleobble)

]

.right-column[![](./img/fris.jpg)]

---

## This Talk

&lt;br&gt;

- Was originally a talk about the `drake` package
  - The pipeline I set up here was meant to motivate the use of `drake`
  - Come talk to me about `drake` if you're interested!

- Will use Twitter and Google Maps geocoding APIs to figure out when and where fires happen in NYC

--

&lt;br&gt;

**Caveats**

This analysis relies on the [rtweet](https://github.com/mkearney/rtweet) and [ggmap](https://github.com/dkahle/ggmap) packages.

To be able to run it in full you'll need a [Twitter API access token](https://rtweet.info/articles/auth.html) and [Google Maps Geocoding API key](https://developers.google.com/maps/documentation/geocoding/intro#Geocoding).

--

&lt;br&gt;
&lt;br&gt;
&lt;br&gt;

All code and slides on [GitHub](https://github.com/aedobbyn/nyr-2019).


---

class: blue-light 

&lt;!-- background-image: url("https://static01.nyt.com/images/2018/12/29/nyregion/28xp-explosion-sub-print/28xp-explosion-sub-facebookJumbo.jpg) --&gt;

## Our Plan

Remember the [crazy blue light](https://twitter.com/NYCFireWire/status/1078478369036165121) in NYC from late December?

--

&lt;p align="left" style="padding-right: 20%;"&gt;
&lt;img src="./img/blue_light.jpg" height="350px"&gt;
&lt;/p&gt;

--

ðŸ˜± ðŸ˜± ðŸ˜±


---

## Our Plan

.pull-right[![](./img/nyc_fire.jpg)]

&lt;br&gt;

The Twitter account that let us know that this wasn't in fact aliens is [NYCFireWire](https://twitter.com/NYCFireWire).

&lt;br&gt;

Normally they just tweet out fires and their locations in a more or less predictable pattern:

&lt;br&gt;


--
Before February:

`&lt;borough&gt; ** &lt;some numbers&gt; ** &lt;address&gt; &lt;description of fire&gt;`

After February:

`&lt;borough&gt; *&lt;type of fire&gt;* Box &lt;digits&gt; &lt;address&gt; &lt;description of fire&gt;`

&lt;br&gt;


We can use their tweets to get some info on where and when fires happen in NYC.


???

I'll illustrate a way you might want to use `drake` with something that's close to home for us.

What if we were constructing an analysis of these tweets and wanted to make sure our pipeline worked end-to-end, but didn't want to unnecessarily re-run outdated parts of it unless we needed to?


---

## The Pipeline

1. Pull in tweets, either the first big batch or any new ones that show up

--

2. Extract addresses from the tweets (ðŸŽ¶ regex time ðŸŽ¶)

--

3. Send addresses to the Google Maps API to grab their latitudes and longitudes

--

4. Profit

--

&lt;br&gt;

All functions are defined in [`didnt_start_it.R`](https://github.com/aedobbyn/nyr-2019/blob/master/R/didnt_start_it.R), which we'll source in now.


```r
source(here::here("R", "didnt_start_it.R")) 
```


---

## Grabbing Tweets

**Pull in tweets, either the first big batch or any new ones that show up**

- This way we can run the same function to look for more tweets at any time, if they exist


---

## Getting Tweets


```r
firewire_handle &lt;- "NYCFireWire"
```

The main function we'll use is `rtweet::get_timeline`.

Which returns a looooot of stuff.


```r
get_timeline(firewire_handle)
## # A tibble: 100 x 88
##    user_id status_id created_at          screen_name text  source
##    &lt;chr&gt;   &lt;chr&gt;     &lt;dttm&gt;              &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt; 
##  1 560024â€¦ 11257160â€¦ 2019-05-07 10:56:35 NYCFireWire Brooâ€¦ thefiâ€¦
##  2 560024â€¦ 11256887â€¦ 2019-05-07 09:08:12 NYCFireWire Brooâ€¦ Twittâ€¦
##  3 560024â€¦ 11256880â€¦ 2019-05-07 09:05:19 NYCFireWire Bronâ€¦ thefiâ€¦
##  4 560024â€¦ 11256528â€¦ 2019-05-07 06:45:32 NYCFireWire Bronâ€¦ thefiâ€¦
##  5 560024â€¦ 11256470â€¦ 2019-05-07 06:22:13 NYCFireWire Brooâ€¦ thefiâ€¦
##  6 560024â€¦ 11256054â€¦ 2019-05-07 03:37:02 NYCFireWire Brooâ€¦ thefiâ€¦
##  7 560024â€¦ 11255194â€¦ 2019-05-06 21:55:21 NYCFireWire Queeâ€¦ thefiâ€¦
##  8 560024â€¦ 11254856â€¦ 2019-05-06 19:41:03 NYCFireWire Brooâ€¦ thefiâ€¦
##  9 560024â€¦ 11253819â€¦ 2019-05-06 12:49:00 NYCFireWire "FDNâ€¦ Twittâ€¦
## 10 560024â€¦ 11253794â€¦ 2019-05-06 12:39:14 NYCFireWire Bronâ€¦ thefiâ€¦
## # â€¦ with 90 more rows, and 82 more variables: display_text_width &lt;dbl&gt;,
## #   reply_to_status_id &lt;lgl&gt;, reply_to_user_id &lt;lgl&gt;,
## #   reply_to_screen_name &lt;lgl&gt;, is_quote &lt;lgl&gt;, is_retweet &lt;lgl&gt;,
## #   favorite_count &lt;int&gt;, retweet_count &lt;int&gt;, hashtags &lt;list&gt;,
## #   symbols &lt;list&gt;, urls_url &lt;list&gt;, urls_t.co &lt;list&gt;,
## #   urls_expanded_url &lt;list&gt;, media_url &lt;list&gt;, media_t.co &lt;list&gt;,
## #   media_expanded_url &lt;list&gt;, media_type &lt;list&gt;, ext_media_url &lt;list&gt;,
## #   ext_media_t.co &lt;list&gt;, ext_media_expanded_url &lt;list&gt;,
## #   ext_media_type &lt;chr&gt;, mentions_user_id &lt;list&gt;,
## #   mentions_screen_name &lt;list&gt;, lang &lt;chr&gt;, quoted_status_id &lt;chr&gt;,
## #   quoted_text &lt;chr&gt;, quoted_created_at &lt;dttm&gt;, quoted_source &lt;chr&gt;,
## #   quoted_favorite_count &lt;int&gt;, quoted_retweet_count &lt;int&gt;,
## #   quoted_user_id &lt;chr&gt;, quoted_screen_name &lt;chr&gt;, quoted_name &lt;chr&gt;,
## #   quoted_followers_count &lt;int&gt;, quoted_friends_count &lt;int&gt;,
## #   quoted_statuses_count &lt;int&gt;, quoted_location &lt;chr&gt;,
## #   quoted_description &lt;chr&gt;, quoted_verified &lt;lgl&gt;,
## #   retweet_status_id &lt;chr&gt;, retweet_text &lt;chr&gt;,
## #   retweet_created_at &lt;dttm&gt;, retweet_source &lt;chr&gt;,
## #   retweet_favorite_count &lt;int&gt;, retweet_retweet_count &lt;int&gt;,
## #   retweet_user_id &lt;chr&gt;, retweet_screen_name &lt;chr&gt;, retweet_name &lt;chr&gt;,
## #   retweet_followers_count &lt;int&gt;, retweet_friends_count &lt;int&gt;,
## #   retweet_statuses_count &lt;int&gt;, retweet_location &lt;chr&gt;,
## #   retweet_description &lt;chr&gt;, retweet_verified &lt;lgl&gt;, place_url &lt;chr&gt;,
## #   place_name &lt;chr&gt;, place_full_name &lt;chr&gt;, place_type &lt;chr&gt;,
## #   country &lt;chr&gt;, country_code &lt;chr&gt;, geo_coords &lt;list&gt;,
## #   coords_coords &lt;list&gt;, bbox_coords &lt;list&gt;, status_url &lt;chr&gt;,
## #   name &lt;chr&gt;, location &lt;chr&gt;, description &lt;chr&gt;, url &lt;chr&gt;,
## #   protected &lt;lgl&gt;, followers_count &lt;int&gt;, friends_count &lt;int&gt;,
## #   listed_count &lt;int&gt;, statuses_count &lt;int&gt;, favourites_count &lt;int&gt;,
## #   account_created_at &lt;dttm&gt;, verified &lt;lgl&gt;, profile_url &lt;chr&gt;,
## #   profile_expanded_url &lt;chr&gt;, account_lang &lt;chr&gt;,
## #   profile_banner_url &lt;chr&gt;, profile_background_url &lt;chr&gt;,
## #   profile_image_url &lt;chr&gt;
```


---

## Getting Tweets

Wowza.

We'll wrap that up in a function that 
- selects only columns we care about  
- writes the result out to a file if we want to.

&lt;br&gt;

One of the most useful arguments to `get_timeline` for pipelining is **`max_id`**

- This lets you specify the most *recent* tweet (since `max_id`s always increase as `created_at` increases) you want; all other tweets will be from before this
- That lets you work backward


---

## Grabbing a Seed Batch of Tweets


```r
get_seed_tweets &lt;- function(user = firewire_handle,
                            n_tweets = 50,
                            max_id = NULL, # Max ID of the tweet
                            input_path = NULL, # Read from a file or grab from Twitter?
                            output_path = NULL,
                            write_out = FALSE,
                            verbose = TRUE) {
  if (!is.null(input_path) &amp;&amp; file_exists(input_path)) {
    if (verbose) message("Reading in tweets from CSV.")
    out &lt;-
      read_csv(input_path,
        col_types =
          list(
            text = col_character(),
            user_id = col_character(),
            status_id = col_character(),
            created_at = col_datetime(format = ""),
            screen_name = col_character()
          )
      )
  } else {
    out &lt;-
      get_timeline(user = user, n = n_tweets, max_id = max_id) %&gt;%
      mutate(
        user_id = as.character(user_id),
        status_id = as.character(status_id),
        created_at = # UTC by default
          lubridate::as_datetime(created_at, tz = "America/New_York")
      ) %&gt;%
      select(text, user_id, status_id, created_at, screen_name) %&gt;%
      arrange(desc(created_at))
  }

  if (!is.null(output_path) &amp;&amp; write_out == TRUE) {
    write_csv(out, output_path)
  }

  out
}
```



```r
# Check if there are new tweets at an account
there_are_new_tweets &lt;- function(tbl,
                                 user = firewire_handle,
                                 verbose = TRUE) {
  latest_dt &lt;-
    tbl %&gt;%
    arrange(desc(created_at)) %&gt;%
    slice(1) %&gt;%
    pull(created_at)

  if (verbose) message("Searching for new tweets.")

  new &lt;- get_seed_tweets(user = user, n_tweets = 1)

  if (max(new$created_at) &lt;= latest_dt) {
    if (verbose) message("No new tweets to pull.")
    FALSE
  } else {
    TRUE
  }
}
```



```r
# Given a tbl of tweets, reup if there_are_new_tweets()
get_more_tweets &lt;- function(tbl,
                            user = firewire_handle,
                            n_tweets = 20,
                            verbose = TRUE) {
  if (!there_are_new_tweets(tbl = tbl, user = user)) {
    return(NULL)
  }

  new &lt;- get_seed_tweets(user = user, n_tweets = n_tweets)

  out &lt;-
    new %&gt;%
    filter(created_at &gt; max(tbl$created_at))

  if (verbose) message(glue("{nrow(out)} new tweet(s) pulled."))

  out
}
```



---

## Grabbing Tweets

[`get_tweets`](https://github.com/aedobbyn/nyc-fires/blob/master/R/didnt_start_it.R)


```r
get_tweets &lt;- function(tbl = NULL,
                       user = firewire_handle,
                       max_id = NULL,
                       n_tweets_seed = 10,
                       n_tweets_reup = 5,
                       input_path = NULL,
                       output_path = NULL,
                       write_out = TRUE,
                       verbose = TRUE) {
  if (is.null(tbl) || is.na(tbl)) {
    out &lt;- get_seed_tweets(
      user = user,
      n_tweets = n_tweets_seed,
      input_path = input_path,
      output_path = output_path,
      write_out = FALSE,
      max_id = max_id
    )
  } else {
    new &lt;-
      get_more_tweets(tbl, user = user, n_tweets = n_tweets_reup, verbose = verbose)

    out &lt;-
      tbl %&gt;%
      bind_rows(new) %&gt;%
      arrange(desc(created_at))
  }

  # Always write to file
  if (!is.null(output_path) &amp;&amp; write_out == TRUE) {
    write_csv(out, output_path)
  }

  out
}
```




---

## Grabbing Tweets

[`get_tweets`](https://github.com/aedobbyn/nyc-fires/blob/master/R/didnt_start_it.R)

--

*Main idea*: 

* **Builds up a file** of the most recent set of tweets from a given account

--

*Details*:
- If neither file nor `tbl` is supplied as arguments, grabs an initial *seed* batch of tweets
- If either is supplied, checks for new tweets and grabs them if any
- Spits out the latest to the same file



&lt;br&gt;


```r
get_tweets(n_tweets_seed = 3)
## # A tibble: 3 x 5
##   text                  user_id status_id   created_at          screen_name
##   &lt;chr&gt;                 &lt;chr&gt;   &lt;chr&gt;       &lt;dttm&gt;              &lt;chr&gt;      
## 1 Brooklyn *MVA/Overtuâ€¦ 560024â€¦ 1125716049â€¦ 2019-05-07 06:56:35 NYCFireWire
## 2 Brooklyn *10-60/Majoâ€¦ 560024â€¦ 1125688773â€¦ 2019-05-07 05:08:12 NYCFireWire
## 3 Bronx *All Hands* Boâ€¦ 560024â€¦ 1125688049â€¦ 2019-05-07 05:05:19 NYCFireWire
```

???

- `get_seed_tweets` grabs a batch of tweets *or* reads in seed tweets from a file if the file exists
- `get_more_tweets` checks if there are new tweets and, if so, pulls in the right number of them
- `get_tweets` runs `get_seed_tweets` if given a null `tbl` argument, otherwise runs `get_more_tweets`


---

## Grabbing Seed Tweets

A closer look at just the text of the tweets:


```r
get_tweets(n_tweets_seed = 5) %&gt;% 
  select(text) %&gt;% 
  kable()
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; text &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn *MVA/Overturned* Box 0920. Sterling &amp;amp;amp; Albany Aves.. E-234 has an overturned auto, no pin. &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn *10-60/Major Emergency* Box 2980. 494 Avenue P. E-330/TL-172 1st due https://t.co/EaiTcDQFgr &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Bronx *All Hands* Box 3103. 2001 Southern Blvd. Fire 1st floor 6 story non-fireproof. &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Bronx *Subway Emergency* Box 7215. E Tremont Av/Grand Concourse E, . Bn19 has a person struck by the train, requesting power off. &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn *All Hands* Box 2564. 1315 54th St, . Basement fire in a synagogue &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;


---

## Reupping Tweets

To show how `get_tweets` can start with a `tbl` of tweets and look for new ones,

we'll grab 10 `seed_tweets` that are all **older** than an old tweet ID.

--

&lt;br&gt;


```r
old_tweet_id &lt;- "1084948074588487680" # From Jan 14

seed_tweets &lt;- 
  get_tweets(
    n_tweets_seed = 10,
    max_id = old_tweet_id
  )

nrow(seed_tweets)
## [1] 10
```

---

## Reupping Tweets

Using `seed_tweets` as an input to the same `get_tweets` function,

we check for new tweets, and, if there are any, pull them in.

--


```r
full_tweets &lt;- 
  get_tweets(seed_tweets, 
             n_tweets_reup = 5)
```

--

&lt;br&gt;


```r
nrow(seed_tweets)
## [1] 10
nrow(full_tweets)
## [1] 15
```

---

## Extracting Addresses


```r
pull_box_address &lt;- function(x) {
  x %&gt;%
    str_extract("Box [0-9]+.+[,\\.]") %&gt;%
    str_extract("\\..+?\\.") %&gt;%
    str_remove_all("[,\\.]") %&gt;%
    str_trim()
}
```



```r
(a_box_address &lt;- 
  full_tweets %&gt;% 
  filter(str_detect(text, "Box [0-9]+[,\\.]")) %&gt;% 
  slice(1) %&gt;% 
  pull(text))
## [1] "Brooklyn *MVA/Overturned* Box 0920. Sterling &amp;amp; Albany Aves.. E-234 has an overturned auto, no pin."
```



```r
a_box_address %&gt;% 
  pull_box_address()
## [1] "Sterling &amp;amp; Albany Aves"
```

---

## Boroughs


```r
# Bronx will become The Bronx and Staten will become Staten Island in clean_borough()
boroughs &lt;- c("Brooklyn", "Bronx", "Manhattan", "Staten", "Queens")
borough_reg &lt;- boroughs %&gt;%
  str_c(collapse = "|")


# Helper used inside pull_addresses()
# If a tweet has a borough anywhere in it, pull it out
clean_borough &lt;- function(x) {
  if (is.na(x) || !str_detect(x, borough_reg)) {
    return(NA_character_)
  }

  # Return the borough match
  b &lt;- boroughs[which(str_detect(x, boroughs))][1]

  if (b == "Bronx") {
    b &lt;- "The Bronx"
  } else if (b == "Staten") {
    b &lt;- "Staten Island"
  }

  b
}
```


---

## Getting Addresses

With `pull_addresses` we parse the text of the tweet to pull out borough and street and string them together into an address.


```r
pull_addresses &lt;- function(tbl) {
  tbl %&gt;%
    mutate(
      text = str_replace_all(text, "&amp;amp;", "&amp;"),
      borough = str_extract(text, "^[^\\s]*\\s") %&gt;%
        str_remove("\\s"),
      street =
        case_when(
          str_detect(text, "Box") ~ pull_box_address(text),
          TRUE ~ pull_non_box_address(text)
        )
    ) %&gt;%
    rowwise() %&gt;%
    mutate(
      borough =
        case_when(
          str_detect(borough, borough_reg) ~ borough %&gt;% clean_borough(),
          TRUE ~ NA_character_
        ),
      address =
        glue::glue("{street}, {borough}", .na = "") %&gt;%
          str_remove("[, ]?") %&gt;%
          str_trim()
    ) %&gt;%
    mutate(
      address = na_if(address, "")
    ) %&gt;%
    select(borough, street, address, text, created_at)
}
```


---

## Getting Addresses


```r
get_tweets(max_id = old_tweet_id) %&gt;% 
  pull_addresses() %&gt;%  
  select(text, street, borough, address) %&gt;% 
  kable() 
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; text &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; street &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; borough &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; address &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Bronx *66-75-3049* 1449 Commonwealth ave. Attic fire private dwelling. &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 1449 Commonwealth ave &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; The Bronx &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 1449 Commonwealth ave, The Bronx &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Manhattan *66-75-0755* 330 E 39 St. Fire in the duct work 3rd floor. 10-77(HiRise Residential). E-16/TL-7 1st due &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 330 E 39 St &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Manhattan &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 330 E 39 St, Manhattan &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Manhattan 10-77* 66-75-2017* 70 Little West St x 2nd Pl. BC01 has a fire on the 7th floor in the laundry area. &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 70 Little West St x 2nd Pl &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Manhattan &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 70 Little West St x 2nd Pl, Manhattan &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Bronx *66-75-2251* 2922 3rd Avenue at Westchester Avenue, Battalion 14 transmitting a 10-75 for a fire on the 4th floor of a 6 story commercial building. Squad 41 First Due &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 2922 3rd Avenue at Westchester Avenue &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; The Bronx &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 2922 3rd Avenue at Westchester Avenue, The Bronx &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn **77-75-0270** 330 Bushwick Avenue Near McKibbin Street, Fire on the 4th Floor &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 330 Bushwick Avenue Near McKibbin Street &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 330 Bushwick Avenue Near McKibbin Street, Brooklyn &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn *77-75-0855* 899 Hancock St. Fire top floor 3 story &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 899 Hancock St &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 899 Hancock St, Brooklyn &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn **77-75-0855** 899 Hancock Street Near Howard Avenue, All hands going to work for fire Iâ€™m the top floor &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 899 Hancock Street Near Howard Avenue &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 899 Hancock Street Near Howard Avenue, Brooklyn &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Bronx *66-75-3937* 3840 Orloff Av. Fire 4th floor. &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 3840 Orloff Av &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; The Bronx &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 3840 Orloff Av, The Bronx &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Staten Island *MVA/PIN* Box 1744-
490 Harold St off Forest Hill Rd. Hurst tool in operation. &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Staten Island &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Staten Island &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Queens 99-75-6810 111-15 227 St BC-54 using all hands for a fire in a pvt dwelling &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Queens &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Queens &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

---

## Getting Lat and Long

Last step of the main pipeline! 

--

**Reverse geocoding** = getting latitude and longitude from an address.

The [`ggmap`](https://www.rdocumentation.org/packages/ggmap/versions/2.6.1/topics/geocode) package exposes this feature of the [Google Maps](https://cloud.google.com/maps-platform/) API.

&lt;br&gt;

--

The `ggmap::geocode` accepts a string and returns a dataframe of `lon` and `lat`.

--


```r
(sherlock &lt;- 
   ggmap::geocode("221B Baker Street, London"))
##          lon      lat
## 1 -0.1585557 51.52377
```

---

#### Where's Sherlock?

--


```r
get_map("london", zoom = 13) %&gt;% 
  ggmap() +
  geom_point(data = sherlock, 
             aes(x = lon, y = lat), 
             color = "blue", size = 10)
```

![](index_files/figure-html/unnamed-chunk-21-1.png)&lt;!-- --&gt;

---


#### Where's Sherlock?

&lt;br&gt;

&lt;p&gt;
  &lt;img src="https://media.giphy.com/media/EVjAANNjkMBKE/giphy.gif" height="300px" align="middle"&gt;
&lt;/p&gt;

---

So we can put that together into a function that works on a tibble.



```r
get_lat_long &lt;- function(tbl) {
  tbl %&gt;%
    mutate(
      address =
        case_when(
          is.na(address) ~ "", # Gives an NA in lat and long response df
          TRUE ~ address
        ),
      l_l = address %&gt;%
        geocode() %&gt;%
        list()
    ) %&gt;%
    unnest() %&gt;%
    select(address, lat, lon, created_at, text) %&gt;%
    rename(long = lon)
}
```


---


```r
full_tweets %&gt;% 
  sample_n(1) %&gt;% 
  pull_addresses() %&gt;% 
  get_lat_long() %&gt;% 
  select(text, address, lat, long) %&gt;% 
  kable()
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; text &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; address &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; lat &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; long &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn **77-75-0855** 899 Hancock Street Near Howard Avenue, All hands going to work for fire Iâ€™m the top floor &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 899 Hancock Street Near Howard Avenue, Brooklyn &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 40.68623 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -73.91941 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;


---

## Counting Up

`count_fires` sums up the total number of fires per `lat`-`long` combo

&lt;br&gt;


```r
count_fires &lt;- function(tbl) {
  tbl %&gt;%
    drop_na() %&gt;%
    count(lat, long)
}
```

&lt;br&gt;

so we can plot them on a map (thanks again, `ggmap`)

---

## Counting Up


```r
fire_sums %&gt;% 
  arrange(desc(n)) %&gt;% 
  slice(1:10)
## # A tibble: 10 x 3
##      lat  long     n
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1  40.7 -73.9    55
##  2  40.8 -74.0    25
##  3  40.7 -73.8    22
##  4  40.8 -73.9    17
##  5  40.6 -74.2    14
##  6  40.6 -73.8     7
##  7  40.9 -73.9     7
##  8  40.6 -73.7     6
##  9  40.6 -73.9     6
## 10  40.7 -73.9     6
```


---

## Mapping


```r
get_map("new york city") %&gt;% 
  ggmap()
```

![](index_files/figure-html/unnamed-chunk-26-1.png)&lt;!-- --&gt;


---


```r
nyc_map &lt;- get_map("new york city", zoom = 7)

plot_fire_sums &lt;- function(tbl, city = nyc_map,
                           output_path = 
                             here("plots", "fire_sums_plot.png"),
                           ...) {
  tbl &lt;-
    tbl %&gt;%
    drop_na(lat, long)

  fire_layer &lt;-
    geom_point(
      data = tbl, aes(long, lat, size = n),
      color = "red", alpha = 0.5
    )

  plt &lt;- ggmap(city) +
    fire_layer +
    ggtitle("Fires were Started") +
    labs(x = "Longitude", y = "Latitude",
         size = "Number of Fires") +
    theme_light()

  if (!is.null(output_path)) {
    ggsave(output_path,
      device = "png"
    )
  } else {
    plt
  }
}
```


---




Using ~3k tweets:


```r
plot_fire_sums(fire_sums, output_path = NULL)
```

![](index_files/figure-html/unnamed-chunk-28-1.png)&lt;!-- --&gt;


&lt;!-- &lt;p&gt; --&gt;
&lt;!-- &lt;img src="./img/fire_sums_plot.png"&gt; --&gt;
&lt;!-- &lt;/p&gt; --&gt;
 

---

## How would this look in a `drake` plan?



```r
plan &lt;-
  drake_plan(
    seed_fires = get_tweets(), 
    fires = target(
      command = get_tweets(tbl = seed_fires),
        # Only pull if there are new tweets
      trigger = trigger(condition = there_are_new_tweets) 
    ),
      # Extract addresses from tweets
    addresses = pull_addresses(fires), 
      # Send to Google for lat-longs
    lat_long = get_lat_long(addresses), 
      # Sum up n fires per lat-long combo
    fire_sums = count_fires(lat_long), 

    time_graph = graph_fire_times(lat_long),
    plot = plot_fire_sums(fire_sums)
  )
```

---


```r
plan
## # A tibble: 7 x 3
##   target     command                   trigger                             
##   &lt;chr&gt;      &lt;expr&gt;                    &lt;expr&gt;                              
## 1 seed_fires get_tweets()            â€¦ NA                                 â€¦
## 2 fires      get_tweets(tbl = seed_fiâ€¦ trigger(condition = there_are_new_tâ€¦
## 3 addresses  pull_addresses(fires)   â€¦ NA                                 â€¦
## 4 lat_long   get_lat_long(addresses) â€¦ NA                                 â€¦
## 5 fire_sums  count_fires(lat_long)   â€¦ NA                                 â€¦
## 6 time_graph graph_fire_times(lat_lonâ€¦ NA                                 â€¦
## 7 plot       plot_fire_sums(fire_sumsâ€¦ NA                                 â€¦
```


---

## Questions?


```r
devtools::session_info()
## â”€ Session info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
##  setting  value                       
##  version  R version 3.5.3 (2019-03-11)
##  os       macOS Mojave 10.14          
##  system   x86_64, darwin15.6.0        
##  ui       RStudio                     
##  language (EN)                        
##  collate  en_US.UTF-8                 
##  ctype    en_US.UTF-8                 
##  tz       America/New_York            
##  date     2019-05-07                  
## 
## â”€ Packages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
##  package       * version    date       lib
##  askpass         1.1        2019-01-13 [2]
##  assertthat      0.2.1      2019-03-21 [2]
##  backports       1.1.4      2019-04-10 [1]
##  base64url       1.4        2018-05-14 [2]
##  bindr           0.1.1      2018-03-13 [2]
##  bindrcpp      * 0.2.2      2018-03-29 [2]
##  BiocInstaller * 1.30.0     2018-05-01 [1]
##  bitops          1.0-6      2013-08-17 [2]
##  broom           0.5.1      2018-12-05 [2]
##  callr           3.2.0      2019-03-15 [2]
##  cellranger      1.1.0      2016-07-27 [2]
##  cli             1.1.0      2019-03-19 [2]
##  codetools       0.2-16     2018-12-24 [2]
##  colorspace      1.4-0      2019-01-13 [2]
##  crayon          1.3.4      2017-09-16 [1]
##  curl            3.3        2019-01-10 [2]
##  desc            1.2.0      2018-05-01 [2]
##  devtools        2.0.2      2019-04-08 [2]
##  digest          0.6.18     2018-10-10 [2]
##  dplyr         * 0.8.0.1    2019-02-15 [2]
##  drake         * 7.2.0      2019-04-19 [1]
##  emo             0.0.0.9000 2018-07-05 [2]
##  emojifont     * 0.5.2      2019-01-17 [2]
##  evaluate        0.13       2019-02-12 [2]
##  fansi           0.4.0      2018-12-20 [2]
##  forcats       * 0.4.0      2019-02-17 [2]
##  fs            * 1.2.7      2019-03-19 [1]
##  generics        0.0.2      2018-11-29 [2]
##  ggmap         * 2.7.904    2019-01-04 [2]
##  ggplot2       * 3.1.0      2018-10-25 [2]
##  glue          * 1.3.1      2019-03-12 [2]
##  gtable          0.2.0      2016-02-26 [2]
##  haven           2.1.0      2019-02-19 [2]
##  here          * 0.1        2017-05-28 [2]
##  highr           0.8        2019-03-20 [1]
##  hms             0.4.2      2018-03-10 [2]
##  htmltools       0.3.6      2017-04-28 [2]
##  httpuv          1.4.5.1    2018-12-18 [2]
##  httr            1.4.0      2018-12-11 [2]
##  igraph          1.2.2      2018-07-27 [2]
##  jpeg            0.1-8      2014-01-23 [2]
##  jsonlite        1.6        2018-12-07 [2]
##  kableExtra    * 1.0.1      2019-01-22 [2]
##  knitr         * 1.22       2019-03-08 [1]
##  labeling        0.3        2014-08-23 [2]
##  later           0.7.5      2018-09-18 [2]
##  lattice         0.20-38    2018-11-04 [2]
##  lazyeval        0.2.1      2017-10-29 [2]
##  lubridate       1.7.4      2018-04-11 [2]
##  magrittr        1.5        2014-11-22 [2]
##  maps          * 3.3.0      2018-04-03 [2]
##  memoise         1.1.0      2017-04-21 [2]
##  mime            0.6        2018-10-05 [2]
##  modelr          0.1.4      2019-02-18 [2]
##  munsell         0.5.0      2018-06-12 [2]
##  nlme            3.1-137    2018-04-07 [2]
##  openssl         1.3        2019-03-22 [1]
##  packrat         0.4.9-10   2018-08-10 [2]
##  pillar          1.3.1.9000 2019-02-03 [2]
##  pkgbuild        1.0.3      2019-03-20 [1]
##  pkgconfig       2.0.2      2018-08-16 [2]
##  pkgload         1.0.2      2018-10-29 [2]
##  plyr            1.8.4      2016-06-08 [2]
##  png             0.1-7      2013-12-03 [2]
##  prettyunits     1.0.2      2015-07-13 [2]
##  processx        3.3.0      2019-03-10 [2]
##  promises        1.0.1      2018-04-13 [2]
##  proto           1.0.0      2016-10-29 [2]
##  ps              1.3.0      2018-12-21 [2]
##  purrr         * 0.3.2      2019-03-15 [2]
##  R6              2.4.0      2019-02-14 [2]
##  Rcpp            1.0.1      2019-03-17 [2]
##  readr         * 1.3.1      2018-12-21 [2]
##  readxl          1.3.0.9000 2019-02-20 [2]
##  remotes         2.0.4      2019-04-10 [1]
##  RgoogleMaps     1.4.3      2018-11-07 [2]
##  rjson           0.2.20     2018-06-08 [2]
##  rlang           0.3.4      2019-04-07 [1]
##  rmarkdown       1.11       2018-12-08 [2]
##  rprojroot       1.3-2      2018-01-03 [2]
##  rstudioapi      0.10       2019-03-19 [1]
##  rtweet        * 0.6.8      2018-09-28 [2]
##  rvest           0.3.2      2016-06-17 [2]
##  scales          1.0.0      2018-08-09 [2]
##  servr           0.11       2018-10-23 [2]
##  sessioninfo     1.1.1      2018-11-05 [2]
##  showtext        0.6        2019-01-10 [2]
##  showtextdb      2.0        2017-09-11 [2]
##  storr           1.2.1      2018-10-18 [2]
##  stringi         1.4.3      2019-03-12 [2]
##  stringr       * 1.4.0      2019-02-10 [2]
##  sysfonts        0.8        2018-10-11 [2]
##  testthat      * 2.0.1      2018-10-13 [2]
##  tibble        * 2.1.1      2019-03-16 [2]
##  tidyr         * 0.8.3      2019-03-01 [2]
##  tidyselect    * 0.2.5      2018-10-11 [2]
##  tidyverse     * 1.2.1      2017-11-14 [2]
##  usethis         1.5.0      2019-04-07 [1]
##  utf8            1.1.4      2018-05-24 [2]
##  viridisLite     0.3.0      2018-02-01 [2]
##  webshot         0.5.1      2018-09-28 [2]
##  withr           2.1.2      2018-03-15 [2]
##  xaringan        0.8.6      2019-02-04 [2]
##  xfun            0.6        2019-04-02 [1]
##  xml2            1.2.0      2018-01-24 [2]
##  yaml            2.2.0      2018-07-25 [2]
##  source                                  
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.3)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  Bioconductor                            
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.3)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.3)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.2)                          
##  Github (hadley/emo@02a5206)             
##  Github (GuangchuangYu/emojifont@f7ba3ec)
##  CRAN (R 3.5.2)                          
##  Github (brodieG/fansi@ab11e9c)          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  Github (dkahle/ggmap@4dfe516)           
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.3)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.3)                          
##  CRAN (R 3.5.2)                          
##  Github (rstudio/packrat@7d320b1)        
##  Github (r-lib/pillar@3a54b8d)           
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  Github (tidyverse/readxl@0fcfb3f)       
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  Github (yihui/xaringan@0d713d5)         
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
## 
## [1] /Users/amanda/Library/R/3.5/library
## [2] /Library/Frameworks/R.framework/Versions/3.5/Resources/library
```


---

class: inverse

&lt;br&gt;

## Thanks!


## ðŸ”¥
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"navigation": {
"scroll": false
}
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
(function() {
  var i, text, code, codes = document.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
})();
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
