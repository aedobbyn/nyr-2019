<!DOCTYPE html>
<html>
  <head>
    <title>This Talk is on Fire</title>
    <meta charset="utf-8">
    <meta name="author" content="Amanda Dobbyn" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/shinobi.css" rel="stylesheet" />
    
      <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="dobbs.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# This Talk is on Fire
## <code>Using Twitter and Google to Track Fires in NYC</code>
### Amanda Dobbyn

---





class: inverse

## Quick About Me

&lt;br&gt;

.left-column[

**Day job**: Data Scientist at [Earlybird Software](http://www.earlybird.co/), former co-organizer of [R-Ladies Chicago](https://rladieschicago.org/)

**For fun**: ultimate frisbee player
&lt;!-- .pull-left[![](./img/pingpong.jpg)] --&gt;

**GitHub**: [@aedobbyn](https://github.com/aedobbyn)

**Website**: https://dobb.ae

**Twitter**: [@dobbleobble](https://twitter.com/dobbleobble)

]

.right-column[![](./img/fris.jpg)]

---

## This Talk


- Was originally a talk about the [`drake`](https://github.com/ropensci/drake) package

--

&lt;img src="./img/happy_drake.jpg" height="200" align="right"&gt;


&lt;br&gt;

- `drake` is a workflow management package for data pipelines (come talk to me about it!)

--

&lt;br&gt;

#### The Pipeline

- Will use Twitter and Google Maps geocoding APIs to figure out when and where fires happen in NYC

--

&lt;br&gt;

**Caveats**

This analysis relies on the [rtweet](https://github.com/mkearney/rtweet) and [ggmap](https://github.com/dkahle/ggmap) packages.

To be able to run it in full you'll need a [Twitter API access token](https://rtweet.info/articles/auth.html) and [Google Maps Geocoding API key](https://developers.google.com/maps/documentation/geocoding/intro#Geocoding).

--

&lt;br&gt;
&lt;br&gt;
&lt;br&gt;

All code and slides on [GitHub](https://github.com/aedobbyn/nyr-2019).


---

class: blue-light 

&lt;!-- background-image: url("https://static01.nyt.com/images/2018/12/29/nyregion/28xp-explosion-sub-print/28xp-explosion-sub-facebookJumbo.jpg) --&gt;

## Why Fires?

Remember the [crazy blue light](https://twitter.com/NYCFireWire/status/1078478369036165121) in NYC from late December?

--

&lt;p align="left" style="padding-right: 20%;"&gt;
&lt;img src="./img/blue_light.jpg" height="350px"&gt;
&lt;/p&gt;

--

üò± üò± üò±


---

.pull-right[![](./img/nyc_fire.jpg)]

&lt;br&gt;

The Twitter account that let us know that this wasn't in fact aliens is [NYCFireWire](https://twitter.com/NYCFireWire).

&lt;br&gt;

Normally they just tweet out fires and their locations in a more or less predictable pattern:

&lt;br&gt;


--
Before February:

`&lt;borough&gt; ** &lt;some numbers&gt; ** &lt;address&gt; &lt;description of fire&gt;`

After February:

`&lt;borough&gt; *&lt;type of fire&gt;* Box &lt;digits&gt; &lt;address&gt; &lt;description of fire&gt;`

&lt;br&gt;


We can use their tweets to get some info on where and when fires happen in NYC.


???

I'll illustrate a way you might want to use `drake` with something that's close to home for us.

What if we were constructing an analysis of these tweets and wanted to make sure our pipeline worked end-to-end, but didn't want to unnecessarily re-run outdated parts of it unless we needed to?


---

## The Pipeline

1. Pull in tweets, either the first big batch or any new ones that show up

--

2. Extract addresses from the tweets (üé∂ regex time üé∂)

--

3. Send addresses to the Google Maps API to grab their latitudes and longitudes

--

4. Profit

--

&lt;br&gt;

All functions are defined in [`didnt_start_it.R`](https://github.com/aedobbyn/nyr-2019/blob/master/R/didnt_start_it.R), which we'll source in now.


```r
source(here::here("R", "didnt_start_it.R")) 
```


---

### Sneak Peek

(Sans `drake`)


```r
# Get tweets
lots_o_fires &lt;-
  get_tweets(
    n_tweets_seed = 3000,
    output_path = here("data", "raw", "lots_o_fires.csv"),
    write_out = TRUE
  )

# Pull out addresses
addresses &lt;-
  pull_addresses(lots_o_fires)

# Geocode
lat_long &lt;-
  get_lat_long(addresses)

# Sum up n fires by lat-long combo
fire_sums &lt;-
  lat_long %&gt;%
  count_fires()
```



---

## Getting Tweets

The main function we'll use is `rtweet::get_timeline`.

--

Which returns a looooot of stuff.


```r
get_timeline("NYCFireWire")
## # A tibble: 100 x 88
##    user_id status_id created_at          screen_name text  source
##    &lt;chr&gt;   &lt;chr&gt;     &lt;dttm&gt;              &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt; 
##  1 560024‚Ä¶ 11259028‚Ä¶ 2019-05-07 23:18:45 NYCFireWire Stat‚Ä¶ thefi‚Ä¶
##  2 560024‚Ä¶ 11258382‚Ä¶ 2019-05-07 19:02:08 NYCFireWire Bron‚Ä¶ thefi‚Ä¶
##  3 560024‚Ä¶ 11258128‚Ä¶ 2019-05-07 17:21:12 NYCFireWire Broo‚Ä¶ thefi‚Ä¶
##  4 560024‚Ä¶ 11257955‚Ä¶ 2019-05-07 16:12:36 NYCFireWire Broo‚Ä¶ thefi‚Ä¶
##  5 560024‚Ä¶ 11257948‚Ä¶ 2019-05-07 16:09:52 NYCFireWire Broo‚Ä¶ thefi‚Ä¶
##  6 560024‚Ä¶ 11257160‚Ä¶ 2019-05-07 10:56:35 NYCFireWire Broo‚Ä¶ thefi‚Ä¶
##  7 560024‚Ä¶ 11256887‚Ä¶ 2019-05-07 09:08:12 NYCFireWire Broo‚Ä¶ Twitt‚Ä¶
##  8 560024‚Ä¶ 11256880‚Ä¶ 2019-05-07 09:05:19 NYCFireWire Bron‚Ä¶ thefi‚Ä¶
##  9 560024‚Ä¶ 11256528‚Ä¶ 2019-05-07 06:45:32 NYCFireWire Bron‚Ä¶ thefi‚Ä¶
## 10 560024‚Ä¶ 11256470‚Ä¶ 2019-05-07 06:22:13 NYCFireWire Broo‚Ä¶ thefi‚Ä¶
## # ‚Ä¶ with 90 more rows, and 82 more variables: display_text_width &lt;dbl&gt;,
## #   reply_to_status_id &lt;lgl&gt;, reply_to_user_id &lt;lgl&gt;,
## #   reply_to_screen_name &lt;lgl&gt;, is_quote &lt;lgl&gt;, is_retweet &lt;lgl&gt;,
## #   favorite_count &lt;int&gt;, retweet_count &lt;int&gt;, hashtags &lt;list&gt;,
## #   symbols &lt;list&gt;, urls_url &lt;list&gt;, urls_t.co &lt;list&gt;,
## #   urls_expanded_url &lt;list&gt;, media_url &lt;list&gt;, media_t.co &lt;list&gt;,
## #   media_expanded_url &lt;list&gt;, media_type &lt;list&gt;, ext_media_url &lt;list&gt;,
## #   ext_media_t.co &lt;list&gt;, ext_media_expanded_url &lt;list&gt;,
## #   ext_media_type &lt;chr&gt;, mentions_user_id &lt;list&gt;,
## #   mentions_screen_name &lt;list&gt;, lang &lt;chr&gt;, quoted_status_id &lt;chr&gt;,
## #   quoted_text &lt;chr&gt;, quoted_created_at &lt;dttm&gt;, quoted_source &lt;chr&gt;,
## #   quoted_favorite_count &lt;int&gt;, quoted_retweet_count &lt;int&gt;,
## #   quoted_user_id &lt;chr&gt;, quoted_screen_name &lt;chr&gt;, quoted_name &lt;chr&gt;,
## #   quoted_followers_count &lt;int&gt;, quoted_friends_count &lt;int&gt;,
## #   quoted_statuses_count &lt;int&gt;, quoted_location &lt;chr&gt;,
## #   quoted_description &lt;chr&gt;, quoted_verified &lt;lgl&gt;,
## #   retweet_status_id &lt;chr&gt;, retweet_text &lt;chr&gt;,
## #   retweet_created_at &lt;dttm&gt;, retweet_source &lt;chr&gt;,
## #   retweet_favorite_count &lt;int&gt;, retweet_retweet_count &lt;int&gt;,
## #   retweet_user_id &lt;chr&gt;, retweet_screen_name &lt;chr&gt;, retweet_name &lt;chr&gt;,
## #   retweet_followers_count &lt;int&gt;, retweet_friends_count &lt;int&gt;,
## #   retweet_statuses_count &lt;int&gt;, retweet_location &lt;chr&gt;,
## #   retweet_description &lt;chr&gt;, retweet_verified &lt;lgl&gt;, place_url &lt;chr&gt;,
## #   place_name &lt;chr&gt;, place_full_name &lt;chr&gt;, place_type &lt;chr&gt;,
## #   country &lt;chr&gt;, country_code &lt;chr&gt;, geo_coords &lt;list&gt;,
## #   coords_coords &lt;list&gt;, bbox_coords &lt;list&gt;, status_url &lt;chr&gt;,
## #   name &lt;chr&gt;, location &lt;chr&gt;, description &lt;chr&gt;, url &lt;chr&gt;,
## #   protected &lt;lgl&gt;, followers_count &lt;int&gt;, friends_count &lt;int&gt;,
## #   listed_count &lt;int&gt;, statuses_count &lt;int&gt;, favourites_count &lt;int&gt;,
## #   account_created_at &lt;dttm&gt;, verified &lt;lgl&gt;, profile_url &lt;chr&gt;,
## #   profile_expanded_url &lt;chr&gt;, account_lang &lt;chr&gt;,
## #   profile_banner_url &lt;chr&gt;, profile_background_url &lt;chr&gt;,
## #   profile_image_url &lt;chr&gt;
```

---

## Getting Tweets

The main function we'll use is `rtweet::get_timeline`.

Which returns a looooot of stuff.

&lt;br&gt;

![](./img/jackjack.jpg)

---

## Getting Tweets

Wowza.

--

&lt;br&gt;

We'll wrap that up in a function that: 

&lt;br&gt;

--

- pulls in tweets, either the first big batch or any new ones that show up

--

&lt;br&gt;

- writes the result out to a file 


---

## Grabbing Tweets

&lt;br&gt;

- `get_seed_tweets` grabs a batch of tweets *or* reads in seed tweets from a file if the file exists

--

&lt;br&gt;

- `get_more_tweets` checks if there are new tweets and, if so, pulls in the right number of them

--

&lt;br&gt;

- `get_tweets` 
  - If *not* passed a dataframe: runs `get_seed_tweets` 
  - If passed a dataframe: runs `get_more_tweets`
  

???

- If neither file nor `tbl` is supplied as arguments, grabs an initial *seed* batch of tweets
- If either is supplied, checks for new tweets and grabs them if any
- Spits out the latest to the same file

---

A simplified version of `get_seed_tweets`:


```r
get_seed_tweets &lt;- function(user = firewire_handle, 
                            n_tweets = 50, max_id = NULL, 
                            input_path = NULL, output_path = NULL, 
                            write_out = FALSE) {
  # If an `input_path` exists, read in from there instead of grabbing tweets.
  if (!is.null(input_path) &amp;&amp; file_exists(input_path)) {
    out &lt;-
      read_csv(input_path)
  } else {
    out &lt;-
      get_timeline(user = user, n = n_tweets, max_id = max_id) %&gt;%
      select(text, user_id, status_id, created_at, screen_name) 
  }

  # If an `output_path` exists, write out what we've got to that path.
  if (!is.null(output_path) &amp;&amp; write_out == TRUE) {
    write_csv(out, output_path)
  }
  out
}
```



---



```r
old_tweet_id &lt;- "1084948074588487680" # From Jan 14
```

`status_id` is useful because we can supply a `max_id` to get only tweets older than that ID üëç

&lt;br&gt;

--


```r
get_seed_tweets(n_tweets = 5,
*            max_id = old_tweet_id) %&gt;%
  select(status_id, created_at)
## # A tibble: 5 x 2
##   status_id           created_at         
##   &lt;chr&gt;               &lt;dttm&gt;             
## 1 1084916640293232641 2019-01-14 15:54:18
## 2 1084883139183497216 2019-01-14 13:41:11
## 3 1084867824680615941 2019-01-14 12:40:19
## 4 1084783776792756224 2019-01-14 07:06:21
## 5 1084638043070447618 2019-01-13 21:27:15
```



---

## Reupping Tweets

Check if there are new tweets at an account:


```r
there_are_new_tweets &lt;- function(tbl,
                                 user = firewire_handle,
                                 verbose = TRUE) {
  latest_dt &lt;-
    tbl %&gt;%
    arrange(desc(created_at)) %&gt;%
    slice(1) %&gt;%
    pull(created_at)

  if (verbose) message("Searching for new tweets.")

  new &lt;- get_seed_tweets(user = user, n_tweets = 1)

  if (max(new$created_at) &lt;= latest_dt) {
    if (verbose) message("No new tweets to pull.")
    FALSE
  } else {
    TRUE
  }
}
```

---

## Reupping Tweets

Reup if `there_are_new_tweets()` is true.


```r
get_more_tweets &lt;- function(tbl,
                            user = firewire_handle,
                            n_tweets = 20,
                            write_out = TRUE,
                            verbose = TRUE) {
  if (!there_are_new_tweets(tbl = tbl, user = user)) {
    return(NULL)
  }
  
  out &lt;- NULL
  
  new &lt;- get_seed_tweets(user = user, n_tweets = n_tweets)
  
  this &lt;-
      new %&gt;%
      filter(created_at &gt; max(tbl$created_at))
  
  out &lt;- 
    out %&gt;% 
    bind_rows(this)
  
  while (min(this$created_at) &lt;= max(tbl$created_at))) {

    if (verbose) message(glue("{nrow(out)} new tweet(s) pulled."))
    
    if (!is.null(output_path) &amp;&amp; write_out == TRUE) {
      write_csv(this, output_path, append = TRUE)
    }
  )

  out
}
```



---

All together now:


```r
get_tweets &lt;- function(tbl = NULL,
                       user = firewire_handle,
                       max_id = NULL,
                       n_tweets_seed = 10,
                       n_tweets_reup = 5,
                       input_path = NULL,
                       output_path = NULL,
                       write_out = TRUE,
                       verbose = TRUE, ...) {
  if (is.null(tbl)) {
    out &lt;- get_seed_tweets(n_tweets = n_tweets_seed, ...)
  } else {
    new &lt;-
      get_more_tweets(n_tweets = n_tweets_reup, ...)

    out &lt;-
      tbl %&gt;%
      bind_rows(new) %&gt;%
      arrange(desc(created_at))
  }

  out
}
```


---


```r
get_tweets(n_tweets_seed = 5)
## # A tibble: 5 x 5
##   text                  user_id status_id   created_at          screen_name
##   &lt;chr&gt;                 &lt;chr&gt;   &lt;chr&gt;       &lt;dttm&gt;              &lt;chr&gt;      
## 1 Staten Island *10-75‚Ä¶ 560024‚Ä¶ 1125902819‚Ä¶ 2019-05-07 19:18:45 NYCFireWire
## 2 Bronx *All Hands* Bo‚Ä¶ 560024‚Ä¶ 1125838243‚Ä¶ 2019-05-07 15:02:08 NYCFireWire
## 3 Brooklyn *All Hands*‚Ä¶ 560024‚Ä¶ 1125812840‚Ä¶ 2019-05-07 13:21:12 NYCFireWire
## 4 Brooklyn *All Hands*‚Ä¶ 560024‚Ä¶ 1125795578‚Ä¶ 2019-05-07 12:12:36 NYCFireWire
## 5 Brooklyn *10-75* Box‚Ä¶ 560024‚Ä¶ 1125794889‚Ä¶ 2019-05-07 12:09:52 NYCFireWire
```


---

A closer look at just the text of the tweets:


```r
get_tweets(n_tweets_seed = 5) %&gt;% 
  select(text) %&gt;% 
  kable()
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; text &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Staten Island *10-75* Box 0404. 31 Rodeo Ln. House fire. Reported jumpers from the 2nd floor &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Bronx *All Hands* Box 3314. 2305 Grand Ave. Fire apt 1C. &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn *All Hands* Box 1568. 167 Lenox Rd. Fire 1st floor 4 story multiple dwelling &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn *All Hands* Box 0751. 193 Wyckoff Ave off Himrod St.. Fire on the roof 3 story frame multiple dwelling. &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn *10-75* Box 0751. 193 Wyckoff Ave off Himrod St.. Fire on the roof 3 story frame multiple dwelling. &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;



---

## Reupping Tweets

To show how `get_tweets` can start with a `tbl` of tweets and look for new ones,

we'll grab 10 `seed_tweets` that are all **older** than an old tweet ID.

--

&lt;br&gt;


```r
seed_tweets &lt;- 
  get_tweets(
    n_tweets_seed = 10,
    max_id = old_tweet_id # Old tweet!
  )

nrow(seed_tweets)
## [1] 10
```

---

## Reupping Tweets

Using `seed_tweets` as an input to the same `get_tweets` function,

we check for new tweets, and, if there are any, pull them in.

--


```r
full_tweets &lt;- 
  get_tweets(seed_tweets, 
             n_tweets_reup = 5)
```

--

&lt;br&gt;


```r
nrow(seed_tweets)
## [1] 10
nrow(full_tweets)
## [1] 15
```

---

## Extracting Addresses


```r
pull_box_address &lt;- function(x) {
  x %&gt;%
    str_extract("Box [0-9]+.+[,\\.]") %&gt;%
    str_extract("\\..+?\\.") %&gt;%
    str_remove_all("[,\\.]") %&gt;%
    str_trim()
}
```



```r
(a_box_address &lt;- 
  full_tweets %&gt;% 
  filter(str_detect(text, "Box [0-9]+[,\\.]")) %&gt;% 
  slice(1) %&gt;% 
  pull(text))
## [1] "Staten Island *10-75* Box 0404. 31 Rodeo Ln. House fire. Reported jumpers from the 2nd floor"
```



```r
a_box_address %&gt;% 
  pull_box_address()
## [1] "31 Rodeo Ln"
```

---

## Boroughs


```r
# Bronx will become The Bronx and Staten will become Staten Island in clean_borough()
boroughs &lt;- c("Brooklyn", "Bronx", "Manhattan", "Staten", "Queens")
borough_reg &lt;- boroughs %&gt;%
  str_c(collapse = "|")

# If a tweet has a borough anywhere in it, pull it out
clean_borough &lt;- function(x) {
  if (is.na(x) || !str_detect(x, borough_reg)) {
    return(NA_character_)
  }

  # Return the borough match
  b &lt;- boroughs[which(str_detect(x, boroughs))][1]

  if (b == "Bronx") {
    b &lt;- "The Bronx"
  } else if (b == "Staten") {
    b &lt;- "Staten Island"
  }

  b
}
```


---

## Getting Addresses

With `pull_addresses` we parse the text of the tweet to pull out borough and street and string them together into an address.


```r
pull_addresses &lt;- function(tbl) {
  tbl %&gt;%
    mutate(
      text = str_replace_all(text, "&amp;amp;", "&amp;"),
      borough = str_extract(text, "^[^\\s]*\\s") %&gt;%
        str_remove("\\s"),
      street =
        case_when(
          str_detect(text, "Box") ~ pull_box_address(text),
          TRUE ~ pull_non_box_address(text)
        )
    ) %&gt;%
    rowwise() %&gt;%
    mutate(
      borough =
        case_when(
          str_detect(borough, borough_reg) ~ borough %&gt;% clean_borough(),
          TRUE ~ NA_character_
        ),
      address =
        glue::glue("{street}, {borough}", .na = "") %&gt;%
          str_remove("[, ]?") %&gt;%
          str_trim()
    ) %&gt;%
    mutate(
      address = na_if(address, "")
    ) %&gt;%
    select(borough, street, address, text, created_at)
}
```


---

## Getting Addresses


```r
get_tweets(max_id = old_tweet_id) %&gt;% 
* pull_addresses() %&gt;%
  select(text, street, borough, address) %&gt;% 
  kable() 
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; text &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; street &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; borough &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; address &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Bronx *66-75-3049* 1449 Commonwealth ave. Attic fire private dwelling. &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 1449 Commonwealth ave &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; The Bronx &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 1449 Commonwealth ave, The Bronx &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Manhattan *66-75-0755* 330 E 39 St. Fire in the duct work 3rd floor. 10-77(HiRise Residential). E-16/TL-7 1st due &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 330 E 39 St &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Manhattan &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 330 E 39 St, Manhattan &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Manhattan 10-77* 66-75-2017* 70 Little West St x 2nd Pl. BC01 has a fire on the 7th floor in the laundry area. &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 70 Little West St x 2nd Pl &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Manhattan &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 70 Little West St x 2nd Pl, Manhattan &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Bronx *66-75-2251* 2922 3rd Avenue at Westchester Avenue, Battalion 14 transmitting a 10-75 for a fire on the 4th floor of a 6 story commercial building. Squad 41 First Due &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 2922 3rd Avenue at Westchester Avenue &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; The Bronx &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 2922 3rd Avenue at Westchester Avenue, The Bronx &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn **77-75-0270** 330 Bushwick Avenue Near McKibbin Street, Fire on the 4th Floor &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 330 Bushwick Avenue Near McKibbin Street &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 330 Bushwick Avenue Near McKibbin Street, Brooklyn &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn *77-75-0855* 899 Hancock St. Fire top floor 3 story &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 899 Hancock St &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 899 Hancock St, Brooklyn &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn **77-75-0855** 899 Hancock Street Near Howard Avenue, All hands going to work for fire I‚Äôm the top floor &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 899 Hancock Street Near Howard Avenue &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 899 Hancock Street Near Howard Avenue, Brooklyn &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Bronx *66-75-3937* 3840 Orloff Av. Fire 4th floor. &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 3840 Orloff Av &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; The Bronx &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 3840 Orloff Av, The Bronx &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Staten Island *MVA/PIN* Box 1744-
490 Harold St off Forest Hill Rd. Hurst tool in operation. &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Staten Island &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Staten Island &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Queens 99-75-6810 111-15 227 St BC-54 using all hands for a fire in a pvt dwelling &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Queens &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Queens &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

---

## Getting Lat and Long

Last step of the main pipeline! 

--

**Reverse geocoding** = getting latitude and longitude from an address.

The [`ggmap`](https://www.rdocumentation.org/packages/ggmap/versions/2.6.1/topics/geocode) package exposes this feature of the [Google Maps](https://cloud.google.com/maps-platform/) API.

&lt;br&gt;

--

The `ggmap::geocode` accepts a string and returns a dataframe of `lon` and `lat`.

--


```r
(sherlock &lt;- 
   ggmap::geocode("221B Baker Street, London"))
##          lon      lat
## 1 -0.1585557 51.52377
```

---

#### Where's Sherlock?

--


```r
get_map("london", zoom = 13) %&gt;% 
  ggmap() +
  geom_point(data = sherlock, 
             aes(x = lon, y = lat), 
             color = "blue", size = 10)
```

![](index_files/figure-html/unnamed-chunk-22-1.png)&lt;!-- --&gt;


## üëã

---


#### Where's Sherlock?

&lt;br&gt;

&lt;p&gt;
  &lt;img src="https://media.giphy.com/media/EVjAANNjkMBKE/giphy.gif" height="300px" align="middle"&gt;
&lt;/p&gt;

---

So we can put that together into a function that works on a tibble.



```r
get_lat_long &lt;- function(tbl) {
  tbl %&gt;%
    mutate(
      address =
        case_when(
          is.na(address) ~ "", # Gives an NA in lat and long response df
          TRUE ~ address
        ),
      l_l = address %&gt;%
        geocode() %&gt;%
        list()
    ) %&gt;%
    unnest() %&gt;%
    select(address, lat, lon, created_at, text) %&gt;%
    rename(long = lon)
}
```


---


```r
full_tweets %&gt;% 
  sample_n(1) %&gt;% 
  pull_addresses() %&gt;% 
  get_lat_long() %&gt;% 
  select(text, address, lat, long) %&gt;% 
  kable()
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; text &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; address &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; lat &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; long &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn **77-75-0855** 899 Hancock Street Near Howard Avenue, All hands going to work for fire I‚Äôm the top floor &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 899 Hancock Street Near Howard Avenue, Brooklyn &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 40.68623 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -73.91941 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;


---

## Counting Up

`count_fires` sums up the total number of fires per `lat`-`long` combo

&lt;br&gt;


```r
count_fires &lt;- function(tbl) {
  tbl %&gt;%
    drop_na() %&gt;%
    count(lat, long)
}
```

&lt;br&gt;

so we can plot them on a map (thanks again, `ggmap`)

---

## Counting Up


```r
fire_sums %&gt;% 
  arrange(desc(n)) %&gt;% 
  slice(1:10)
## # A tibble: 10 x 3
##      lat  long     n
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1  40.7 -73.9    55
##  2  40.8 -74.0    25
##  3  40.7 -73.8    22
##  4  40.8 -73.9    17
##  5  40.6 -74.2    14
##  6  40.6 -73.8     7
##  7  40.9 -73.9     7
##  8  40.6 -73.7     6
##  9  40.6 -73.9     6
## 10  40.7 -73.9     6
```


---

## Mapping


```r
get_map("new york city") %&gt;% 
  ggmap()
```

![](index_files/figure-html/unnamed-chunk-27-1.png)&lt;!-- --&gt;


---


```r
nyc_map &lt;- get_map("new york city", zoom = 11)

plot_fire_sums &lt;- function(tbl, city = nyc_map,
                           output_path = 
                             here("plots", "fire_sums_plot.png"),
                           ...) {
  tbl &lt;-
    tbl %&gt;%
    drop_na(lat, long)

  fire_layer &lt;-
    geom_point(
      data = tbl, aes(long, lat, size = n),
      color = "red", alpha = 0.5
    )

  plt &lt;- ggmap(city) +
    fire_layer +
    ggtitle("Fires were Started") +
    labs(x = "Longitude", y = "Latitude",
         size = "Number of Fires") +
    theme_light()

  if (!is.null(output_path)) {
    ggsave(output_path,
      device = "png"
    )
  } else {
    plt
  }
}
```


---

Using ~3k tweets:


```r
plot_fire_sums(fire_sums, output_path = NULL)
```

![](index_files/figure-html/unnamed-chunk-28-1.png)&lt;!-- --&gt;


&lt;!-- &lt;p&gt; --&gt;
&lt;!-- &lt;img src="./img/fire_sums_plot.png"&gt; --&gt;
&lt;!-- &lt;/p&gt; --&gt;
 
---

![](https://media.giphy.com/media/5VMNcCxVBibZK/giphy.gif)

---

### How would this look in a `drake` plan?

&lt;br&gt;


```r
plan &lt;-
  drake_plan(
    seed_fires = get_tweets(), 
    fires = target(
      command = get_tweets(tbl = seed_fires),
        # Only pull if there are new tweets
      trigger = trigger(condition = there_are_new_tweets) 
    ),
      # Extract addresses from tweets
    addresses = pull_addresses(fires), 
      # Send to Google for lat-longs
    lat_long = get_lat_long(addresses), 
      # Sum up n fires per lat-long combo
    fire_sums = count_fires(lat_long)
  )
```

---

### How would this look in a `drake` plan?

&lt;br&gt;


```r
plan
## # A tibble: 5 x 3
##   target     command                   trigger                             
##   &lt;chr&gt;      &lt;expr&gt;                    &lt;expr&gt;                              
## 1 seed_fires get_tweets()            ‚Ä¶ NA                                 ‚Ä¶
## 2 fires      get_tweets(tbl = seed_fi‚Ä¶ trigger(condition = there_are_new_t‚Ä¶
## 3 addresses  pull_addresses(fires)   ‚Ä¶ NA                                 ‚Ä¶
## 4 lat_long   get_lat_long(addresses) ‚Ä¶ NA                                 ‚Ä¶
## 5 fire_sums  count_fires(lat_long)   ‚Ä¶ NA                                 ‚Ä¶
```


---

class: inverse

&lt;br&gt;

## Thanks!
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"navigation": {
"scroll": false
}
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
(function() {
  var i, text, code, codes = document.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
})();
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
